{% extends "base.html" %}
{% load thumbnail %}
{% block title %}People{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h1 class="card-title mb-0"><i class="fas fa-users me-2"></i>Discover People</h1>
                </div>
                <div class="card-body">
                    <div class="row" id="people-list">
                        {% for user in users %}
                        <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                            <div class="card h-100 user-card shadow-sm">
                                <div class="card-body text-center">
                                    <a href="{{ user.get_absolute_url }}" class="text-decoration-none">
                                        {% if user.profile.photo %}
                                            <img src="{% thumbnail user.profile.photo 120x120 crop='100%' %}" alt="{{ user.get_full_name }}" class="rounded-circle mb-3 border">
                                        {% else %}
                                            <div class="bg-secondary rounded-circle d-flex align-items-center justify-content-center mb-3 border" style="width: 120px; height: 120px; margin: 0 auto;">
                                                <i class="fas fa-user text-white fa-3x"></i>
                                            </div>
                                        {% endif %}
                                        <h6 class="card-title mb-1">{{ user.get_full_name|default:user.username }}</h6>
                                        <p class="text-muted small mb-3">@{{ user.username }}</p>
                                    </a>
                                    <div class="follow-info">
                                        <small class="text-muted d-block">{{ user.followers.count }} followers</small>
                                        <small class="text-muted d-block">{{ user.images_created.count }} posts</small>
                                    </div>
                                    {% if user != request.user %}
                                        {% if user in request.user.following.all %}
                                            <button class="btn btn-outline-secondary btn-sm mt-2 follow-btn" data-id="{{ user.id }}" data-action="unfollow">
                                                <i class="fas fa-user-check me-1"></i>Following
                                            </button>
                                        {% else %}
                                            <button class="btn btn-primary btn-sm mt-2 follow-btn" data-id="{{ user.id }}" data-action="follow">
                                                <i class="fas fa-user-plus me-1"></i>Follow
                                            </button>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12 text-center py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5>No users found</h5>
                            <p class="text-muted">Be the first to join!</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.user-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    border: none;
    border-radius: 15px;
}

.user-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 25px rgba(0,0,0,0.15);
}

.user-card img {
    width: 120px;
    height: 120px;
    object-fit: cover;
}

.follow-btn {
    border-radius: 20px;
    font-weight: 500;
}

.follow-info small {
    margin-bottom: 2px;
}

@media (max-width: 576px) {
    .user-card .card-body {
        padding: 1rem;
    }
    .user-card img {
        width: 100px;
        height: 100px;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const url = '{% url "user_follow" %}';
    const options = {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        mode: 'same-origin'
    };

    const followButtons = document.querySelectorAll('.follow-btn');
    followButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const followButton = this;
            const card = this.closest('.user-card');
            const followerCountEl = card.querySelector('.follow-info small:first-child');

            // add request body
            const formData = new FormData();
            formData.append('id', followButton.dataset.id);
            formData.append('action', followButton.dataset.action);
            options.body = formData;

            // send HTTP request
            fetch(url, options)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    const previousAction = followButton.dataset.action;

                    // toggle button text and data-action
                    const action = previousAction === 'follow' ? 'unfollow' : 'follow';
                    followButton.dataset.action = action;
                    if (action === 'follow') {
                        followButton.innerHTML = '<i class="fas fa-user-plus me-1"></i>Follow';
                        followButton.classList.remove('btn-outline-secondary');
                        followButton.classList.add('btn-primary');
                    } else {
                        followButton.innerHTML = '<i class="fas fa-user-check me-1"></i>Following';
                        followButton.classList.remove('btn-primary');
                        followButton.classList.add('btn-outline-secondary');
                    }

                    // update follower count
                    let totalFollowers = parseInt(followerCountEl.textContent.split(' ')[0]);
                    followerCountEl.textContent = (previousAction === 'follow' ? totalFollowers + 1 : totalFollowers - 1) + ' followers';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error occurred. Please try again.');
            });
        });
    });
});
</script>
{% endblock %}