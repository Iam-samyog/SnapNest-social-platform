{% extends "base.html" %}
{% load thumbnail %}

{% block title %}{{ user.get_full_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
  <div class="row">
    <!-- Profile Picture -->
    <div class="col-md-4 text-center">
      <img src="{% thumbnail user.profile.photo 150x150 %}" class="rounded-circle border" style="width: 150px; height: 150px; object-fit: cover;" alt="{{ user.get_full_name }}">
    </div>
    <!-- Profile Info -->
    <div class="col-md-8">
      <div class="d-flex align-items-center mb-3">
        <h2 class="mb-0 me-3">{{ user.username }}</h2>
        {% if user != request.user %}
          <a href="#" data-id="{{ user.id }}" data-action="{% if request.user in user.followers.all %}un{% endif %}follow" class="btn btn-primary follow">
            {% if request.user not in user.followers.all %}
              Follow
            {% else %}
              Unfollow
            {% endif %}
          </a>
        {% endif %}
      </div>
      <!-- Stats -->
      <div class="d-flex mb-3">
        <div class="me-4">
          <strong>{{ user.images_created.count }}</strong> posts
        </div>
        <div class="me-4">
          <strong><span class="follower-count">{{ user.followers.count }}</span></strong> followers
        </div>
        <div>
          <strong>{{ user.following.count }}</strong> following
        </div>
      </div>
      <!-- Bio -->
      {% if user.profile.bio %}
        <p class="mb-3">{{ user.profile.bio }}</p>
      {% endif %}
      <p><strong>{{ user.get_full_name }}</strong></p>
    </div>
  </div>
  <!-- Images Grid -->
  <div class="row mt-4">
    <div class="col-12">
      <div id="image-list" class="image-container">
        {% include "images/image/list_images.html" with images=user.images_created.all %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block domready %}
  const url = '{% url "user_follow" %}';
  var options = {
    method: 'POST',
    headers: {'X-CSRFToken': csrftoken},
    mode: 'same-origin'
  }

  document.querySelector('a.follow')
          .addEventListener('click', function(e){
    e.preventDefault();
    var followButton = this;

    // add request body
    var formData = new FormData();
    formData.append('id', followButton.dataset.id);
    formData.append('action', followButton.dataset.action);
    options['body'] = formData;

    // send HTTP request
    fetch(url, options)
    .then(response => response.json())
    .then(data => {
      if (data['status'] === 'ok')
      {
        var previousAction = followButton.dataset.action;

        // toggle button text and data-action
        var action = previousAction === 'follow' ? 'unfollow' : 'follow';
        followButton.dataset.action = action;
        followButton.innerHTML = action;

        // update follower count
        var followerCount = document.querySelector('.follower-count');
        var totalFollowers = parseInt(followerCount.innerHTML);
        followerCount.innerHTML = previousAction === 'follow' ? totalFollowers + 1 : totalFollowers - 1;
      }
    })
  });
{% endblock %}